

<script type="text/javascript" src="http://7u2ss1.com1.z0.glb.clouddn.com/love.js"></script>
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
	<script src="http://echarts.baidu.com/dist/echarts.common.min.js"></script>
	<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
    </style>


    

    <title>DLL劫持漏洞自动化识别工具Rattler测试 | </title>
    <meta name="author" content="wiki">
    
    <meta name="description" content="0x00 前言
最近，来自SensePost的Chris Le Roy开源了一款工具：Rattler，可用来自动识别DLL是否存在预加载漏洞(也可以理解为DLL劫持漏洞，文中该名词均采用DLL劫持漏洞)。虽然DLL劫持漏洞已不再是新技术，可追溯到2010年，但是我对自动化很是感兴趣，于是对此做了进一">
    
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta property="og:title" content="DLL劫持漏洞自动化识别工具Rattler测试"/>
    <meta property="og:site_name" content="wiki"/>

    
    <meta property="og:image" content=""/>
    

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="alternate" href="/atom.xml" title="wiki" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/materialize.min.css">
    <link rel="stylesheet" href="/css/lib/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/lastest.css" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</head>

<style>

</style>
<body style="background-color:#2196f3">

<script type="text/javascript"
color="100,238,23" opacity='0.7' zIndex="-2" count="100" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.15.0/TweenMax.min.js"></script>
    <img src="/weixin_favicon.png" style="position: absolute; left: -9999px; opacity: 0; filter: alpha(opacity=0);">

    <nav class="indigo darken-1">
    
    <div class="nav-wrapper">
        <a href="#" data-activates="main-menu" class="button-collapse">
            <i class="fa fa-navicon"></i>
        </a>
        <div class="">
            <a href="/" class="brand-logo hide-on-med-and-down">wiki</a>
            <ul class="right hide-on-med-and-down">
                
                    <li>
                        <a class="menu-home " href="/" >
                            <i class="fa fa-home "></i>
                            
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-archive " href="/archives" >
                            <i class="fa fa-archive "></i>
                            
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                            <i class="fa fa-bookmark "></i>
                            
                            分类
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-search modal-trigger " href="#search" >
                            <i class="fa fa-search "></i>
                            
                            搜索
                        </a>
                    </li>
                
            </ul>
            <div>
    <ul class="side-nav indigo darken-2" id="main-menu">
        
        <li class="side-user">
            <div class="row">
                <div class="col s4 no-padding">
                    <img class="avatar-image circle responsive-img" src="http://p4gdp8beq.bkt.clouddn.com/timgsi1.jpg" alt="User Avatar">
                </div>
                <div class="info col s8 valign-wrapper no-padding">
                    <div class="valign">
                        <p class="name">wiki</p>
                        <p class="desc">安全小白</p>
                    </div>
                </div>
            </div>
        </li>
        

        
            <li class="no-padding">
                <a class="waves-effect menu-home " href="/" >
                    <i class="fa fa-home "></i>
                    
                    首页
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-archive " href="/archives" >
                    <i class="fa fa-archive "></i>
                    
                    归档
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                    <i class="fa fa-bookmark "></i>
                    
                    分类
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-search modal-trigger " href="#search" >
                    <i class="fa fa-search "></i>
                    
                    搜索
                </a>
            </li>
        
    </ul>

    <ul class="side-nav indigo darken-2" id="category-menu">
    

            

    </ul>
</div>

        </div>
    </div>
</nav>

<div id="search" class="modal search-modal">
    <div class="row">
        <div class="input-field col s12">
              <input id="search-input" type="text">
              <label for="search-input">搜索</label>
        </div>

    </div>
    <div id="search-result" class="search-result col s12">

    </div>
</div>


    <main>
<div class="container main-container">
    <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<nav class="page-nav hide-on-small-only">
    <div class="nav-wrapper indigo darken-2">
        <span class="breadcrumb">当前位置（分类目录）</span>
        
            

        

        
    </div>
</nav>

<article>
    <div class="card">
	<!-- 添加渲染 -->
	<div id="toc" class="toc-article">
		<strong class="toc-title"></strong>
	</div> 
        <div class="card-content">
		  
			
            

            <div class="article-title">
                
    
        <h1>DLL劫持漏洞自动化识别工具Rattler测试</h1>
    


            </div>
            <time class="red-link-context" datetime="2018-05-25T13:03:44.721Z"><a href="">2018-05-25</a></time>

            <span id="busuanzi_container_page_pv" class="read-times-container">
    <i class="fa fa-eye"></i>
    <span id="busuanzi_value_page_pv"></span>
</span>

            

            <div class="toc red-link-context hide-on-med-and-down">
    <ol class="section table-of-contents"><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#0x00-前言"><span class="section table-of-contents-text">0x00 前言</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#0x01-简介"><span class="section table-of-contents-text">0x01 简介</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#DLL劫持漏洞根源"><span class="section table-of-contents-text">DLL劫持漏洞根源</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#SafeDllSearchMode"><span class="section table-of-contents-text">SafeDllSearchMode</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#KnownDLLs"><span class="section table-of-contents-text">KnownDLLs</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#SafeDllSearchMode-KnownDLLs"><span class="section table-of-contents-text">SafeDllSearchMode+KnownDLLs</span></a></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#0x02-利用实例"><span class="section table-of-contents-text">0x02 利用实例</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#0x03-实际利用"><span class="section table-of-contents-text">0x03 实际利用</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#0x04-程序自动化实现"><span class="section table-of-contents-text">0x04 程序自动化实现</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#0x05-验证测试"><span class="section table-of-contents-text">0x05 验证测试</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#0x06-防御"><span class="section table-of-contents-text">0x06 防御</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#1、开发者需要注意的问题："><span class="section table-of-contents-text">1、开发者需要注意的问题：</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#2、用户需要注意的问题："><span class="section table-of-contents-text">2、用户需要注意的问题：</span></a></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#0x07-小结"><span class="section table-of-contents-text">0x07 小结</span></a></li></ol>
</div>


            <div class="entry red-link-context">
                <script src="\assets\js\APlayer.min.js"> </script><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><hr>
<p>最近，来自SensePost的Chris Le Roy开源了一款工具：<code>Rattler</code>，可用来自动识别DLL是否存在预加载漏洞(也可以理解为DLL劫持漏洞，文中该名词均采用DLL劫持漏洞)。虽然DLL劫持漏洞已不再是新技术，可追溯到2010年，但是我对自动化很是感兴趣，于是对此做了进一步研究。</p>
<p>本文将理清DLL劫持漏洞原理，实例分析，测试自动化工具Rattler，分享心得，并测试一个存在该漏洞的软件——Explorer Suite安装包</p>
<p><strong>注：</strong></p>
<pre><code>Explorer Suite安装包内包含CFF Explorer，免费，常用来编辑PE文件格式，最后更新于2012年11月18日，是比较小众的一款工具。
对于分析PE文件格式，建议使用作者另一款更专业的工具：Cerbero Profiler
</code></pre><hr>
<p>Chris Le Roy介绍Rattler的博客地址：</p>
<p><a href="https://sensepost.com/blog/2016/rattleridentifying-and-exploiting-dll-preloading-vulnerabilities/" target="_blank" rel="noopener">https://sensepost.com/blog/2016/rattleridentifying-and-exploiting-dll-preloading-vulnerabilities/</a></p>
<p>Chris Le Roy在BSides Cape Town上也介绍了Rattler，简介如下：</p>
<p><a href="http://www.bsidescapetown.co.za/speaker/chris-le-roy/" target="_blank" rel="noopener">http://www.bsidescapetown.co.za/speaker/chris-le-roy/</a></p>
<h2 id="0x01-简介"><a href="#0x01-简介" class="headerlink" title="0x01 简介"></a>0x01 简介</h2><hr>
<h3 id="DLL劫持漏洞根源"><a href="#DLL劫持漏洞根源" class="headerlink" title="DLL劫持漏洞根源"></a>DLL劫持漏洞根源</h3><p>程序在调用DLL时未指明DLL的完整路径</p>
<h3 id="SafeDllSearchMode"><a href="#SafeDllSearchMode" class="headerlink" title="SafeDllSearchMode"></a>SafeDllSearchMode</h3><p>从WindowsXPSP2开始，SafeDllSearchMode默认开启，SafeDllSearchMode的存在是为了阻止在XP时代存在的DLL劫持漏洞</p>
<p><strong>注：</strong></p>
<pre><code>强制关闭SafeDllSearchMode的方法：

创建注册表项
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\SafeDllSearchMode
值设为0 
</code></pre><p>程序在调用DLL时，如果未指明DLL的完整路径，那么系统会按照一套固定的搜索顺序寻找DLL</p>
<p>如果SafeDllSearchMode开启，程序会依次从以下位置查找DLL文件：</p>
<p>The directory from which the application loaded</p>
<p>The system directory</p>
<p>The 16-bit system directory</p>
<p>The Windows directory</p>
<p>The current directory</p>
<p>The directories that are listed in the PATH environment variable</p>
<p>如果关闭，则从以下位置查找DLL文件：</p>
<p>The directory from which the application loaded</p>
<p>The current directory</p>
<p>The system directory</p>
<p>The 16-bit system directory</p>
<p>The Windows directory</p>
<p>The directories that are listed in the PATH environment variable</p>
<p>详细内容见：</p>
<p><a href="https://msdn.microsoft.com/en-us/library/ms682586(VS.85).aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/ms682586(VS.85).aspx</a></p>
<h3 id="KnownDLLs"><a href="#KnownDLLs" class="headerlink" title="KnownDLLs"></a>KnownDLLs</h3><p>注册表位置：</p>
<p><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs</code></p>
<p>KnownDLLs注册表项下包含一系列常见的系统dll，如usp10.dll、lpk.dll、shell32.dll、user32.dll</p>
<p><strong>注：</strong></p>
<pre><code>如果创建注册表项
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\ExcludeFromKnownDlls
并指定具体dll名称，可以使KnownDLLs列表中同名的dll保护失效
修改后需要重启才能生效
</code></pre><h3 id="SafeDllSearchMode-KnownDLLs"><a href="#SafeDllSearchMode-KnownDLLs" class="headerlink" title="SafeDllSearchMode+KnownDLLs"></a>SafeDllSearchMode+KnownDLLs</h3><p>二者结合可用来防范对系统dll的劫持</p>
<p><strong>注：</strong></p>
<pre><code>系统dll是指排除ExcludeFromKnownDlls项后，KnownDLLs注册表项下包含的dll列表
</code></pre><p>如果调用的dll“不常见”，也就是并未出现在KnownDLLs的列表中，那么无论SafeDllSearchMode是否开启，dll搜索的第一顺序均为程序的当前目录，这里就存在一个DLL劫持漏洞：</p>
<pre><code>在程序同级目录下预先放置一个同名的dll，在进程启动的过程中会优先加载，实现劫持
</code></pre><p><strong>注：</strong></p>
<pre><code>这里提到的DLL劫持漏洞微软尚未给出直接的修复方法，个人认为原因有以下几点：

1. 这是开发者的失误，换用绝对路径就能避免这个问题
2. 利用的前提是攻击者已经能够在同级目录放置文件，这代表系统已经被攻破
3. 如果直接修复，或许会影响老版本程序，兼容性不好
</code></pre><p><strong>注：</strong></p>
<pre><code>该文章对理清上述顺序起到很大帮助：
http://www.freebuf.com/articles/78807.html
</code></pre><h2 id="0x02-利用实例"><a href="#0x02-利用实例" class="headerlink" title="0x02 利用实例"></a>0x02 利用实例</h2><hr>
<p>接下来编写一个存在DLL劫持漏洞的实例，演示如何利用</p>
<p>测试dll：</p>
<p>使用dll模板，具体代码略，加载成功后弹出计算器</p>
<p>测试程序的c++代码如下：</p>
<pre><code>#include &quot;stdafx.h&quot;
#include &lt;windows.h&gt; 

int main()
{
    HMODULE hDllLib = LoadLibrary(_T(&quot;Kernel32.dll&quot;));
    if (hDllLib)
    {
        FARPROC fpFun = GetProcAddress(hDllLib, &quot;GetVersion&quot;);
        DWORD dwVersion = (*fpFun)();
        DWORD dwWindowsMajorVersion = (DWORD)(LOBYTE(LOWORD(dwVersion)));
        DWORD dwWindowsMinorVersion = (DWORD)(HIBYTE(LOWORD(dwVersion)));
        printf(&quot;version:%d,%d \n&quot;, dwWindowsMajorVersion, dwWindowsMinorVersion);    
        FreeLibrary(hDllLib);
    }
    HMODULE hDllLib2 = LoadLibrary(_T(&quot;CRYPTSP.dll&quot;));
    FreeLibrary(hDllLib2);
    return 0;
}
</code></pre><p>程序通过LoadLibrary分别调用<code>Kernel32.dll</code>和<code>CRYPTSP.dll</code></p>
<p><strong>实际测试：</strong></p>
<p>将测试dll重命名为Kernel32.dll，并放于程序同级目录下，运行如图</p>
<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-12-7/1-1.png" alt="Alt text"></p>
<p>由于Kernel32.dll出现在KnownDLLs的列表中，所以在程序同级目录下的Kernel32.dll并不会被加载</p>
<p>然后将测试dll重命名为CRYPTSP.dll，并放于程序同级目录下，运行如图</p>
<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-12-7/1-2.png" alt="Alt text"></p>
<p>由于CRYPTSP.dll并未在KnownDLLs的列表中，所以在程序同级目录下的CRYPTSP.dll被加载，成功弹出计算器</p>
<h2 id="0x03-实际利用"><a href="#0x03-实际利用" class="headerlink" title="0x03 实际利用"></a>0x03 实际利用</h2><hr>
<p>本节通过实例介绍如何使用Process Monitor查找程序中存在的DLL劫持漏洞，测试实例为Chris Le Roy在介绍Rattler的博客中提到过的<code>NDP461-KB3102438-Web.exe</code></p>
<p>博客地址如下：</p>
<p><a href="https://sensepost.com/blog/2016/rattleridentifying-and-exploiting-dll-preloading-vulnerabilities/" target="_blank" rel="noopener">https://sensepost.com/blog/2016/rattleridentifying-and-exploiting-dll-preloading-vulnerabilities/</a></p>
<p>NDP461-KB3102438-Web.exe的下载地址：</p>
<p><a href="http://www.microsoft.com/zh-cn/download/details.aspx?id=49981&amp;134b2bb0-86c1-fe9f-d523-281faef41695=1&amp;fa43d42b-25b5-4a42-fe9b-1634f450f5ee=True" target="_blank" rel="noopener">http://www.microsoft.com/zh-cn/download/details.aspx?id=49981&amp;134b2bb0-86c1-fe9f-d523-281faef41695=1&amp;fa43d42b-25b5-4a42-fe9b-1634f450f5ee=True</a></p>
<p>使用Process Monitor做如下设置：</p>
<pre><code>Include the following filters:
Operation is CreateFile
Operation is LoadImage
Path contains .cpl
Path contains .dll
Path contains .drv
Path contains .exe
Path contains .ocx
Path contains .scr
Path contains .sys

Exclude the following filters:
Process Name is procmon.exe
Process Name is Procmon64.exe
Process Name is System
Operation begins with IRP_MJ_
Operation begins with FASTIO_
Result is SUCCESS
Path ends with pagefile.sys
</code></pre><p>参考地址：</p>
<p><a href="https://msdn.microsoft.com/library/ff919712" target="_blank" rel="noopener">https://msdn.microsoft.com/library/ff919712</a></p>
<p><strong>注：</strong></p>
<pre><code>设置Exclude Result is SUCCESS后会只显示NAME NOT FOUND项，也就是只查看未成功加载的dll项，即KnownDLLs的列表中不包含的dll名称，可用于查找存在漏洞的dll路径
</code></pre><p>如图</p>
<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-12-7/2-1.png" alt="Alt text"></p>
<p>启动NDP461-KB3102438-Web.exe后，查看Process Monitor，如图</p>
<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-12-7/2-2.png" alt="Alt text"></p>
<p>可以看到<code>NDP461-KB3102438-Web.exe</code>在启动的过程中会加载<code>CRYPTSP.dll</code>，同时显示<code>NAME NOT FOUND</code>，表示无法找到该文件，加载失败</p>
<p>现在将测试dll重命名为<code>CRYPTSP.dll</code>，并放于NDP461-KB3102438-Web.exe的同级目录下</p>
<p>打开Process Monitor，设置Filter，去掉Exclude Result is SUCCESS项，再次启动NDP461-KB3102438-Web.exe并记录</p>
<p>如下图，显示<code>C:\test\CRYPTSP.dll</code>已被成功加载，Result为Success，DLL劫持成功</p>
<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-12-7/2-4.png" alt="Alt text"></p>
<p>如下图，程序在执行过程中成功弹出计算器</p>
<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-12-7/2-3.png" alt="Alt text"></p>
<h2 id="0x04-程序自动化实现"><a href="#0x04-程序自动化实现" class="headerlink" title="0x04 程序自动化实现"></a>0x04 程序自动化实现</h2><hr>
<p>通过Process Monitor查看DLL劫持漏洞是比较直接的方法，但是对于较大的程序，加载的DLL数目很多，手动查找很不现实，费事费力，所以如果能够通过程序实现上述过程，自动查找并利用，就可以大大提高效率，这就是Rattler所解决的问题</p>
<p>项目地址：</p>
<p><a href="https://github.com/sensepost/rattler" target="_blank" rel="noopener">https://github.com/sensepost/rattler</a></p>
<p><strong>思路：</strong></p>
<ul>
<li><p>枚举进程调用的dll列表，解析出dll的名称</p>
</li>
<li><p>将测试dll分别重命名为列表中的dll名称</p>
</li>
<li><p>再次启动程序，检测是否成功创建进程calc.exe,如果成功，代表存在漏洞，否则不存在</p>
</li>
</ul>
<p><strong>实际测试：</strong></p>
<p>使用Visual Studio编译Rattler</p>
<p>将payload.dll放于同级目录下</p>
<p>payload.dll下载地址：</p>
<p><a href="https://github.com/sensepost/rattler/releases/download/v1.0/payload.dll" target="_blank" rel="noopener">https://github.com/sensepost/rattler/releases/download/v1.0/payload.dll</a></p>
<p>管理员权限的cmd下运行命令：</p>
<pre><code>Rattler.exe NDP461-KB3102438-Web.exe 1
</code></pre><p><strong>注：</strong></p>
<pre><code>因为NDP461-KB3102438-Web.exe需要管理员权限运行，所以cmd也需要管理员权限
</code></pre><p>如下图，自动找到存在预加载漏洞的dll列表</p>
<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-12-7/2-5.png" alt="Alt text"></p>
<p><strong>注：</strong></p>
<pre><code>在反复启动进程的过程中，calc.exe没有正常被关闭，所以得出的结果要多于实际结果
</code></pre><p><strong>补充：</strong></p>
<p>下载的NDP461-KB3102438-Web.exe通常位于Downloads文件夹下，所以只要在该目录预先放置CRYPTSP.dll，那么在用户下载运行NDP461-KB3102438-Web.exe的过程中，就能够实现加载CRYPTSP.dll</p>
<p>同时，安装NDP461-KB3102438-Web.exe需要管理员权限，那么此时CRYPTSP.dll也获得了管理员权限</p>
<h2 id="0x05-验证测试"><a href="#0x05-验证测试" class="headerlink" title="0x05 验证测试"></a>0x05 验证测试</h2><hr>
<p>掌握该方法后，测试其他程序，例如CFF Explorer的安装包<code>Explorer Suite</code></p>
<p>下载地址：<br><a href="http://www.ntcore.com/exsuite.php" target="_blank" rel="noopener">http://www.ntcore.com/exsuite.php</a></p>
<p>同样借助Process Monitor查看CFF Explorer的安装包ExplorerSuite.exe在启动过程中的操作</p>
<p>如图，找到ExplorerSuite.exe在启动过程中加载的dll列表</p>
<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-12-7/3-1.png" alt="Alt text"></p>
<p>经实际测试，将payload.dll重命名为apphelp.dll或者dwmapi.dll均能够触发payload，弹出计算器</p>
<p><strong>自动化程序测试：</strong></p>
<p>如图，得出存在劫持漏洞的dll列表</p>
<p><img src="https://raw.githubusercontent.com/3gstudent/BlogPic/master/2016-12-7/3-2.png" alt="Alt text"></p>
<p><strong>注：</strong></p>
<pre><code>在反复启动进程的过程中，calc.exe正常被关闭，所以得出的结果准确
</code></pre><h2 id="0x06-防御"><a href="#0x06-防御" class="headerlink" title="0x06 防御"></a>0x06 防御</h2><hr>
<h3 id="1、开发者需要注意的问题："><a href="#1、开发者需要注意的问题：" class="headerlink" title="1、开发者需要注意的问题："></a>1、开发者需要注意的问题：</h3><ul>
<li>调用第三方DLL时，使用LoadLibrary API加载DLL时使用绝对路径，类似的情况还包括其他API如LoadLibraryEx, CreateProcess, ShellExecute等，将所有需要使用到的DLL放在应用程序所在的目录，不放到系统目录或者其他目录</li>
<li>调用系统DLL时，使用绝对路径</li>
<li>程序启动时调用API SetDllDirectory(L””)将当前目录从DLL加载顺序中移除</li>
</ul>
<p><strong>补充：</strong></p>
<p>从Windows 7的KB2533623补丁开始，微软更新了三个解决DLL劫持问题的新API：SetDefaultDllDirectories，AddDllDirectory，RemoveDllDirectory这几个API配合使用，可以有效的规避DLL劫持问题</p>
<p>但是这些API只能在打了KB2533623补丁的Windows7和Server2008上使用</p>
<p>详情见：</p>
<p><a href="https://support.microsoft.com/zh-cn/kb/2533623" target="_blank" rel="noopener">https://support.microsoft.com/zh-cn/kb/2533623</a></p>
<h3 id="2、用户需要注意的问题："><a href="#2、用户需要注意的问题：" class="headerlink" title="2、用户需要注意的问题："></a>2、用户需要注意的问题：</h3><ul>
<li>留意浏览器下载目录下是否有可疑dll，防止其劫持下载的安装程序</li>
<li>对于“不可信”的程序，建议使用Process Monitor或者Rattler检查是否存在DLL劫持漏洞</li>
</ul>
<h2 id="0x07-小结"><a href="#0x07-小结" class="headerlink" title="0x07 小结"></a>0x07 小结</h2><hr>
<p>我在对DLL劫持漏洞原理的研究过程中，走了一小段弯路，某些资料提到</p>
<blockquote>
<p>如果进程尝试加载的DLL并不存在，那么进程仍然会尝试去当前目录加载这个DLL，这是SafeDllSearchMode所无法防范的。</p>
</blockquote>
<p>这让我产生了如下疑问：</p>
<ol>
<li><p>这里提到的“并不存在的DLL”究竟是指哪些dll?系统不存在的dll?但CRYPTSP.dll却是系统默认的包含的dll</p>
</li>
<li><p>“SafeDllSearchMode所无法防范的”DLL劫持到底是指什么?难道DLL劫持还有多种?有几种?</p>
</li>
</ol>
<p>好在最终解决了这些问题，希望本文也能帮助有同样疑惑的人</p>
<p>利用DLL劫持漏洞自动化识别工具Rattler对常用工具进行测试，能很快找出存在的漏洞位置，高效，方便，值得测试使用</p>
<hr>
<p><a href="https://github.com/3gstudent/feedback/issues/new" target="_blank" rel="noopener">LEAVE A REPLY</a></p>

                
<p class="red-link-context">
    <a href="33a84fb1.html" rel="next" title="隐写技巧——利用PNG文件格式隐藏Payload">
    上一篇：隐写技巧——利用PNG文件格式隐藏Payload
  </a>
</p>



<p class="red-link-context">
    <a href="6dfb79c5.html" rel="next" title="渗透技巧——快捷方式文件的参数隐藏技巧">
    下一篇：渗透技巧——快捷方式文件的参数隐藏技巧
  </a>
</p>


            </div>
			
        </div>
    </div>
	
</article>

<!-- JiaThis Button BEGIN -->
<div class="jiathis_style_32x32">
	<a class="jiathis_button_qzone"></a>
	<a class="jiathis_button_tsina"></a>
	<a class="jiathis_button_tqq"></a>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_renren"></a>
	<a href="http://www.jiathis.com/share?uid=2157721" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=2157721" charset="utf-8"></script>
<!-- JiaThis Button END -->

<!-- ������City�氲װ���� -->
<div id="lv-container" data-id="city" data-uid="MTAyMC8zNDIxOS8xMDc1Nw==">
	<script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
	</script>
<noscript> Ϊ����ʹ�����������۹����뼤��JavaScript</noscript>
</div>
<!-- City�氲װ��������� -->

 
</div>

        <div class="fixed-action-btn float-sitemap">
    <a class="btn-floating btn-large red">
      <i class="fa fa-caret-square-o-up"></i>
    </a>
    <ul>
      <li><a class="btn-return-top btn-floating waves-effect brown" title="回到顶部"><i class="fa fa-arrow-circle-o-up"></i></a></li>
      <li><a class="btn-floating waves-effect button-collapse indigo"  data-activates="main-menu" title="菜单"><i class="fa fa-navicon"></i></a></li>
    </ul>	
  </div>
	
    </main>
    
  

<script type="text/javascript" src="http://imagestp.cfyqy.com/cfyqy/pet/js/jquery.min.js"></script>
<script type="text/javascript" src="http://imagestp.cfyqy.com/cfyqy/pet/js/spig.js"></script>
<link rel="stylesheet" href="http://imagestp.cfyqy.com/cfyqy/pet/css/spigPet.css" type="text/css"/>
<script type="text/javascript">
var isindex = true;
var visitor = true;
</script>
<div >
<!--小人只在首页显示 start*-->
<div id="spig" class="spig">
    <div id="message">正在加载中……</div>
    <div id="mumu" class="mumu"></div>
</div>
</div>
<!--小人end*-->
 
<footer class="page-footer indigo darken-1 darken-1">
	
    <div class="footer-container container">
        <div class="row">
            
            <div class="social-group col m4 s12">
                <h5 class="white-text">社交</h5>
                
                    <a class="social-link" href="" target="_blank">
                        <i class="fa fa-2x fa-weibo"></i>
                    </a>
                
                    <a class="social-link" href="" target="_blank">
                        <i class="fa fa-2x fa-github"></i>
                    </a>
                
                    <a class="social-link" href="/atom.xml" target="_blank">
                        <i class="fa fa-2x fa-rss"></i>
                    </a>
                
                
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
    </script>
    <div class="site-visitors-container white-text">
        <span>
            <i class="fa fa-user"></i>
            <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
        </span>
        <span>&nbsp;|&nbsp;</span>
        <span>
            <i class="fa fa-eye"></i>
            <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
        </span>
    </div>


            </div>
            
           
            <div class="col m8 s12">
                <h5 class="white-text">友情链接</h5>
                
                    <a class="social-link" href="http://www.itxueke.com/SecNavi/#3782" target="_blank">IT学客安全导航</a>
                
            </div>
            
        </div>
    </div>
    
    <div class="footer-copyright red-link-context">
        <div class="container">
            © just do !
        </div>
    </div>
	
</footer>

	

<script>(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/APP_ID.js","daovoice");</script>
<script>
  daovoice('init', {
    app_id: "45fb937d",
  });
  daovoice('update');
</script>
  <noscript>
    <div class="noscript">
        <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
    </div>
</noscript>
<div class="noscript">
    <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
</div>


<script src="/js/jquery.min.js"></script>
<script src="/js/materialize.min.js"></script>

<script>
    (function($) {
        $(document).ready(function() {
            // 隐藏禁用javascript（针对微信内置浏览器）的提示
            $('.noscript').hide();

            // 图片缩放效果
            var $imgs = $('img').not('.slider-image').not('.avatar-image').not('.carousel-image').not('.card-cover-image').not('.qrcode');

            // 给图片加上点击放大效果（materialbox插件）
            $imgs.addClass('materialboxed').each(function(i, el) {
                $(this).attr('data-caption', $(this).attr('alt') || ' ');
            }).materialbox();

            // 优化表格的显示
            $('table').each(function() {
                var $table = $(this);
                // 除去多行代码的情况
                if ($table.find('pre').length == 0) {
                    $table.addClass('responsive-table striped bordered');
                }
            });

            // 首页幻灯片
            $('.slider').slider({indicators: true, full_width: true, interval: 8000});

            $(".button-collapse").sideNav();
            $(".category-menu").sideNav();

            // 针对gallery post
            $('.carousel').carousel({full_width: true});
            $('.carousel-control.prev').click(function() {
                $('.carousel').carousel('prev');
            });
            $('.carousel-control.next').click(function() {
                $('.carousel').carousel('next');
            });

            // 文章目录
            $('article').not('.simple-article').find('h1').add('h2').add('h3').add('h4').add('h5').add('h6').scrollSpy();

            // 目录随屏幕滚动（防止目录过长越过footer）
            var $toc = $('.toc');
            var scrollTargetTop = 0;
            $(window).scroll(function() {
                var $activeLink = $toc.find('a.active.section');
                if ($(window).scrollTop() < 100) {
                    scrollTargetTop = 0;
                } else {
                    if ($activeLink[0]) {
                        scrollTargetTop = $activeLink.offset().top - $toc.offset().top;
                    }
                }
                $toc.css('top', '-' + scrollTargetTop + 'px');
            });

            // 修正文章目录的left-border颜色
            var color = $('.table-of-contents-text').css('color');
            $('.table-of-contents-link').css('border-left-color', color);

            // 针对移动端做的优化：FAB按钮点击一下收回
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                $('.fixed-action-btn').addClass('click-to-toggle');
            }
            // 回到顶部
            $('.btn-return-top').click(function() {
                $('body, html').animate({
                    scrollTop: 0
                }, 500);
            });

            // 重置读书页面的Tab标签页的颜色
            $('li.tab a').hover(function() {
                $(this).toggleClass('text-lighten-4');
            });
            $('.indicator').addClass(' lighten-2');

            
            // 添加new标签
            $('.menu-reading, .menu-about').append('<span class="new badge red"></span>');
            

            // 搜索功能
            $('.modal-trigger').leanModal({
                // 打开搜索框时自动聚焦
                ready: function() {
                    if ($('#search').is(":visible")) {
                        $('#search-input').focus();
                    }
                }
            });
            var searchXml = "search.xml";
            if (searchXml.length == 0) {
             	searchXml = "search.xml";
            }
            var searchPath = "/" + searchXml;
            initSearch(searchPath, 'search-input', 'search-result');
        });

        // 初始化搜索与匹配函数
        var initSearch = function(path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function(xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function() {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function() {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function(data) {
                            var isMatch = true;
                            var content_index = [];
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title != '' && data_content != '') {
                                keywords.forEach(function(keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    data_title = data_title.replace(regS, "<span class=\"search-keyword red lighten-2\">" + keyword + "</span>");
                                });

                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start == 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substring(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function(keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<span class=\"search-keyword red lighten-2\">" + keyword + "</span>");
                                    });

                                    str += "<p class=\"search-result\">..." + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        }
    })(jQuery);
</script>


<script src="/js/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', '119424621', 'auto');
    ga('send', 'pageview');

</script>



<script type="text/javascript" src="http://tajs.qq.com/stats?sId=65311650" charset="UTF-8"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<script type="text/javascript" async
  src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

	
</body>
</html>
